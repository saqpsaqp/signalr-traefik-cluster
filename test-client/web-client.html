<!DOCTYPE html>
<html>
<head>
    <title>SignalR Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; }
        .system { color: #666; font-style: italic; }
        input, button { padding: 5px; margin: 5px; }
        #messageInput { width: 300px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>SignalR Cluster Chat Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    <div id="nodeInfo" class="status disconnected">Node: Unknown</div>
    
    <div>
        <input type="text" id="userInput" placeholder="Your name" value="TestUser" />
        <button id="connectButton">Connect</button>
        <button id="disconnectButton" disabled>Disconnect</button>
        <button id="getNodeButton" disabled>Get Node Info</button>
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Type a message..." disabled />
        <button id="sendButton" disabled>Send</button>
    </div>
    
    <div>
        <input type="text" id="groupInput" placeholder="Group name" value="TestGroup" />
        <button id="joinGroupButton" disabled>Join Group</button>
        <button id="leaveGroupButton" disabled>Leave Group</button>
        <button id="sendGroupButton" disabled>Send to Group</button>
    </div>
    
    <div id="messages"></div>

    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:8888/chathub")
            .build();

        const statusDiv = document.getElementById("status");
        const nodeInfoDiv = document.getElementById("nodeInfo");
        const messagesDiv = document.getElementById("messages");
        const userInput = document.getElementById("userInput");
        const messageInput = document.getElementById("messageInput");
        const groupInput = document.getElementById("groupInput");
        const connectButton = document.getElementById("connectButton");
        const disconnectButton = document.getElementById("disconnectButton");
        const getNodeButton = document.getElementById("getNodeButton");
        const sendButton = document.getElementById("sendButton");
        const joinGroupButton = document.getElementById("joinGroupButton");
        const leaveGroupButton = document.getElementById("leaveGroupButton");
        const sendGroupButton = document.getElementById("sendGroupButton");

        function addMessage(user, message, connectionId, nodeId = '', isSystem = false) {
            const div = document.createElement("div");
            div.className = isSystem ? "message system" : "message";
            const nodeText = nodeId ? ` [${nodeId}]` : '';
            div.innerHTML = `<strong>${user}:</strong> ${message} <small>(${connectionId}${nodeText})</small>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(connected) {
            if (connected) {
                statusDiv.textContent = `Connected (ID: ${connection.connectionId})`;
                statusDiv.className = "status connected";
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                getNodeButton.disabled = false;
                messageInput.disabled = false;
                sendButton.disabled = false;
                joinGroupButton.disabled = false;
                leaveGroupButton.disabled = false;
                sendGroupButton.disabled = false;
            } else {
                statusDiv.textContent = "Disconnected";
                statusDiv.className = "status disconnected";
                nodeInfoDiv.textContent = "Node: Unknown";
                nodeInfoDiv.className = "status disconnected";
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                getNodeButton.disabled = true;
                messageInput.disabled = true;
                sendButton.disabled = true;
                joinGroupButton.disabled = true;
                leaveGroupButton.disabled = true;
                sendGroupButton.disabled = true;
            }
        }

        connection.on("ReceiveMessage", function (user, message, connectionId, nodeId) {
            addMessage(user, message, connectionId, nodeId, user === "System");
        });

        connection.on("NodeInfo", function (nodeId, connectionId) {
            nodeInfoDiv.textContent = `Node: ${nodeId}`;
            nodeInfoDiv.className = "status connected";
        });

        connectButton.addEventListener("click", function () {
            connection.start().then(function () {
                updateStatus(true);
                connection.invoke("GetNodeInfo").catch(function (err) {
                    console.error(err.toString());
                });
            }).catch(function (err) {
                console.error(err.toString());
                alert("Connection failed: " + err.toString());
            });
        });

        getNodeButton.addEventListener("click", function () {
            connection.invoke("GetNodeInfo").catch(function (err) {
                console.error(err.toString());
            });
        });

        disconnectButton.addEventListener("click", function () {
            connection.stop();
        });

        sendButton.addEventListener("click", function () {
            const user = userInput.value;
            const message = messageInput.value;
            if (user && message) {
                connection.invoke("SendMessage", user, message).catch(function (err) {
                    console.error(err.toString());
                });
                messageInput.value = "";
            }
        });

        joinGroupButton.addEventListener("click", function () {
            const groupName = groupInput.value;
            if (groupName) {
                connection.invoke("JoinGroup", groupName).catch(function (err) {
                    console.error(err.toString());
                });
            }
        });

        leaveGroupButton.addEventListener("click", function () {
            const groupName = groupInput.value;
            if (groupName) {
                connection.invoke("LeaveGroup", groupName).catch(function (err) {
                    console.error(err.toString());
                });
            }
        });

        sendGroupButton.addEventListener("click", function () {
            const user = userInput.value;
            const message = messageInput.value;
            const groupName = groupInput.value;
            if (user && message && groupName) {
                connection.invoke("SendToGroup", groupName, user, message).catch(function (err) {
                    console.error(err.toString());
                });
                messageInput.value = "";
            }
        });

        messageInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                sendButton.click();
            }
        });

        connection.onclose(function () {
            updateStatus(false);
        });

        updateStatus(false);
    </script>
</body>
</html>